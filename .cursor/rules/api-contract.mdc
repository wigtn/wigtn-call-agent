---
description: API contract - Single Source of Truth for all API request/response shapes
globs: **/*
alwaysApply: true
---

# API Contract (SSOT) - v2

> This is the **Single Source of Truth** for all API schemas.
> ALL roles MUST reference this document when writing API calls or handlers.
> **v2 ë³€ê²½ì‚¬í•­**: ì±„íŒ… ê¸°ë°˜ ì •ë³´ ìˆ˜ì§‘ + Supabase PostgreSQL

---

## Authentication (Supabase Auth)

ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ëŠ” **Supabase Auth JWT**ë¡œ ì¸ì¦ë©ë‹ˆë‹¤.

- `middleware.ts`ê°€ ì„¸ì…˜ì„ ìžë™ ê°±ì‹ í•˜ê³ , ë¯¸ì¸ì¦ ì‚¬ìš©ìžë¥¼ `/login`ìœ¼ë¡œ redirect
- API Routesì—ì„œ `createClient()`ë¡œ ì„œë²„ì¸¡ Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•˜ë©´ í˜„ìž¬ ìœ ì € í™•ì¸ ê°€ëŠ¥
- `userId`ëŠ” Supabase Authì˜ `user.id` (UUID)

```typescript
// API Routeì—ì„œ ì¸ì¦ëœ ìœ ì € ê°€ì ¸ì˜¤ê¸°
import { createClient } from '@/lib/supabase/server'

const supabase = await createClient()
const { data: { user } } = await supabase.auth.getUser()
if (!user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
const userId = user.id
```

### OAuth Providers

| Provider | Supabase ì§€ì› | ì„¤ì • ìœ„ì¹˜ |
|----------|--------------|-----------|
| **Google** | ë„¤ì´í‹°ë¸Œ | Supabase Dashboard â†’ Auth â†’ Providers â†’ Google |
| **Apple** | ë„¤ì´í‹°ë¸Œ | Supabase Dashboard â†’ Auth â†’ Providers â†’ Apple |
| **Kakao** | ë„¤ì´í‹°ë¸Œ | Supabase Dashboard â†’ Auth â†’ Providers â†’ Kakao |

### OAuth Callback

```
/auth/callback â€” Supabase OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ í•¸ë“¤ëŸ¬
GET /auth/callback?code=xxx â†’ ì„¸ì…˜ êµí™˜ â†’ / ë¡œ redirect
```

---

## Shared TypeScript Types

```typescript
// shared/types.ts - BE1 owns this file

// ============================================
// v2: ëŒ€í™”(Conversation) ê´€ë ¨ íƒ€ìž… (ì‹ ê·œ)
// ============================================

export type ConversationStatus =
  | 'COLLECTING'   // ì •ë³´ ìˆ˜ì§‘ ì¤‘
  | 'READY'        // ìˆ˜ì§‘ ì™„ë£Œ, ì „í™” ê°€ëŠ¥
  | 'CALLING'      // ì „í™” ì¤‘
  | 'COMPLETED'    // ì™„ë£Œ
  | 'CANCELLED'    // ì·¨ì†Œë¨

export interface CollectedData {
  // í•„ìˆ˜ (ëª¨ë‘ ì±„ì›Œì ¸ì•¼ READY)
  target_name: string | null
  target_phone: string | null
  scenario_type: 'RESERVATION' | 'INQUIRY' | 'AS_REQUEST' | null
  primary_datetime: string | null  // ISO 8601 ë˜ëŠ” ìžì—°ì–´ ("ë‚´ì¼ ì˜¤í›„ 3ì‹œ")

  // ì„ íƒ (ìžˆìœ¼ë©´ ì¢‹ìŒ)
  service: string | null
  fallback_datetimes: string[]     // ëŒ€ì•ˆ ì‹œê°„ë“¤
  fallback_action: 'ask_available' | 'next_day' | 'cancel' | null
  customer_name: string | null
  party_size: number | null
  special_request: string | null
}

export interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  createdAt: string       // ISO 8601
}

export interface Conversation {
  id: string
  userId: string
  status: ConversationStatus
  collectedData: CollectedData
  messages: Message[]
  createdAt: string
  updatedAt: string
}

// ============================================
// Call ê´€ë ¨ íƒ€ìž… (v2ì—ì„œ ìˆ˜ì •)
// ============================================

export interface Call {
  id: string
  userId: string          // Supabase Auth user ID (UUID)
  conversationId: string  // v2: ëŒ€í™” ì„¸ì…˜ ID (í•„ìˆ˜)
  requestType: 'RESERVATION' | 'INQUIRY' | 'AS_REQUEST'
  targetName: string
  targetPhone: string
  parsedDate?: string     // "2026-02-07" (YYYY-MM-DD)
  parsedTime?: string     // "15:00" (HH:MM, 24h)
  parsedService?: string  // "ì»¤íŠ¸"
  status: 'PENDING' | 'CALLING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED'
  result?: 'SUCCESS' | 'NO_ANSWER' | 'REJECTED' | 'ERROR'
  summary?: string
  elevenLabsConversationId?: string  // ElevenLabs í†µí™” ID
  createdAt: string       // ISO 8601
  completedAt?: string    // ISO 8601
}

export interface CreateCallRequest {
  conversationId: string  // v2: ëŒ€í™” ì„¸ì…˜ ID (í•„ìˆ˜)
  // collectedDataëŠ” ì„œë²„ì—ì„œ conversationì—ì„œ ì¡°íšŒ
}
```

---

## Endpoint 0-1: POST /api/conversations (ì‹ ê·œ)

**Owner**: BE1 (route handler) | FE1 (caller)
**Purpose**: Start a new chat conversation for information collection

### Request
```json
{}
```
> No body required. User ID is extracted from Supabase Auth.

### Response 201 Created
```json
{
  "id": "uuid-conversation-id",
  "userId": "uuid-user-id",
  "status": "COLLECTING",
  "collectedData": {
    "target_name": null,
    "target_phone": null,
    "scenario_type": null,
    "primary_datetime": null,
    "service": null,
    "fallback_datetimes": [],
    "fallback_action": null,
    "customer_name": null,
    "party_size": null,
    "special_request": null
  },
  "greeting": "ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì „í™”ë¥¼ ëŒ€ì‹  ê±¸ì–´ë“œë¦´ê¹Œìš”? ðŸ˜Š",
  "createdAt": "2026-02-06T10:30:00.000Z"
}
```

### FE1 Usage Example
```typescript
// hooks/useChat.ts
const startConversation = async () => {
  const res = await fetch('/api/conversations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  const data = await res.json()
  setConversationId(data.id)
  setMessages([{
    id: crypto.randomUUID(),
    role: 'assistant',
    content: data.greeting,
    createdAt: new Date().toISOString()
  }])
}
```

---

## Endpoint 0-2: POST /api/chat (ì‹ ê·œ)

**Owner**: BE1 (route handler) | FE1 (caller)
**Purpose**: Send user message and get AI response with collected data

### Request
```json
{
  "conversationId": "uuid-conversation-id",
  "message": "ë‚´ì¼ ì˜¤í›„ 3ì‹œì— OOë¯¸ìš©ì‹¤ ì»¤íŠ¸ ì˜ˆì•½í•´ì¤˜"
}
```

### Response 200 OK
```json
{
  "message": "OOë¯¸ìš©ì‹¤ì— ì „í™”í•  ì „í™”ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!",
  "collected": {
    "target_name": "OOë¯¸ìš©ì‹¤",
    "target_phone": null,
    "scenario_type": "RESERVATION",
    "primary_datetime": "ë‚´ì¼ ì˜¤í›„ 3ì‹œ",
    "service": "ì»¤íŠ¸",
    "fallback_datetimes": [],
    "fallback_action": null,
    "customer_name": null,
    "party_size": null,
    "special_request": null
  },
  "is_complete": false,
  "conversation_status": "COLLECTING"
}
```

### Response 200 OK (ìˆ˜ì§‘ ì™„ë£Œ ì‹œ)
```json
{
  "message": "ì¢‹ì•„ìš”! ì •ë¦¬í•´ë³¼ê²Œìš”:\n\nðŸ“ OOë¯¸ìš©ì‹¤ (010-1234-5678)\nðŸ“… ë‚´ì¼ ì˜¤í›„ 3ì‹œ\nâœ‚ï¸ ì»¤íŠ¸\n\në§žìœ¼ì‹œë©´ ì „í™” ê±¸ì–´ë³¼ê²Œìš”!",
  "collected": {
    "target_name": "OOë¯¸ìš©ì‹¤",
    "target_phone": "010-1234-5678",
    "scenario_type": "RESERVATION",
    "primary_datetime": "ë‚´ì¼ ì˜¤í›„ 3ì‹œ",
    "service": "ì»¤íŠ¸",
    "fallback_datetimes": [],
    "fallback_action": "ask_available",
    "customer_name": null,
    "party_size": null,
    "special_request": null
  },
  "is_complete": true,
  "conversation_status": "READY"
}
```

### FE1 Usage Example
```typescript
// hooks/useChat.ts
const sendMessage = async (content: string) => {
  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ conversationId, message: content })
  })
  const data = await res.json()

  setMessages(prev => [...prev, {
    id: crypto.randomUUID(),
    role: 'assistant',
    content: data.message,
    createdAt: new Date().toISOString()
  }])
  setCollectedData(data.collected)
  setIsComplete(data.is_complete)
}
```

---

## Endpoint 0-3: GET /api/conversations/[id] (ì‹ ê·œ)

**Owner**: BE1 (route handler) | FE1 (caller)
**Purpose**: Recover conversation after page refresh

### Response 200 OK
```json
{
  "id": "uuid-conversation-id",
  "userId": "uuid-user-id",
  "status": "COLLECTING",
  "collectedData": {
    "target_name": "OOë¯¸ìš©ì‹¤",
    "target_phone": null,
    "scenario_type": "RESERVATION",
    "primary_datetime": "ë‚´ì¼ ì˜¤í›„ 3ì‹œ",
    "service": "ì»¤íŠ¸",
    "fallback_datetimes": [],
    "fallback_action": null,
    "customer_name": null,
    "party_size": null,
    "special_request": null
  },
  "messages": [
    {
      "id": "uuid-msg-1",
      "role": "assistant",
      "content": "ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì „í™”ë¥¼ ëŒ€ì‹  ê±¸ì–´ë“œë¦´ê¹Œìš”?",
      "createdAt": "2026-02-06T10:30:00.000Z"
    },
    {
      "id": "uuid-msg-2",
      "role": "user",
      "content": "ë‚´ì¼ ì˜¤í›„ 3ì‹œì— OOë¯¸ìš©ì‹¤ ì»¤íŠ¸ ì˜ˆì•½í•´ì¤˜",
      "createdAt": "2026-02-06T10:30:30.000Z"
    },
    {
      "id": "uuid-msg-3",
      "role": "assistant",
      "content": "OOë¯¸ìš©ì‹¤ì— ì „í™”í•  ì „í™”ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!",
      "createdAt": "2026-02-06T10:30:32.000Z"
    }
  ],
  "createdAt": "2026-02-06T10:30:00.000Z",
  "updatedAt": "2026-02-06T10:30:32.000Z"
}
```

### FE1 Usage Example (ëŒ€í™” ë³µêµ¬)
```typescript
// hooks/useChat.ts
useEffect(() => {
  const savedId = localStorage.getItem('currentConversationId')
  if (savedId) {
    resumeConversation(savedId)
  } else {
    startConversation()
  }
}, [])

const resumeConversation = async (conversationId: string) => {
  const res = await fetch(`/api/conversations/${conversationId}`)
  const data = await res.json()

  setConversationId(data.id)
  setMessages(data.messages)
  setCollectedData(data.collectedData)
  setIsComplete(data.status === 'READY')
}
```

---

## Endpoint 1: POST /api/calls (v2 ìˆ˜ì •)

**Owner**: BE1 (route handler) | FE1 (caller)
**Purpose**: Create a new call from collected conversation data

### Request (v2)
```json
{
  "conversationId": "uuid-conversation-id"
}
```
> v2: ëŒ€í™” ì„¸ì…˜ IDë§Œ ì „ë‹¬. ìˆ˜ì§‘ëœ ë°ì´í„°ëŠ” ì„œë²„ì—ì„œ conversationì—ì„œ ì¡°íšŒ.

### Response 201 Created
```json
{
  "id": "uuid-call-id",
  "userId": "uuid-user-id",
  "conversationId": "uuid-conversation-id",
  "requestType": "RESERVATION",
  "targetName": "OOë¯¸ìš©ì‹¤",
  "targetPhone": "010-1234-5678",
  "parsedDate": "2026-02-07",
  "parsedTime": "15:00",
  "parsedService": "ì»¤íŠ¸",
  "status": "PENDING",
  "result": null,
  "summary": null,
  "elevenLabsConversationId": null,
  "createdAt": "2026-02-06T10:30:00.000Z",
  "completedAt": null
}
```

### Response 400 Bad Request
```json
{
  "error": "conversationId is required"
}
```

```json
{
  "error": "Conversation is not ready for call"
}
```

### Response 500 Internal Server Error
```json
{
  "error": "Failed to create call"
}
```

### FE1 Usage Example (v2)
```typescript
// components/chat/CollectionSummary.tsx
const handleStartCall = async () => {
  // 1. Call ìƒì„±
  const res = await fetch('/api/calls', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ conversationId })
  })
  const call = await res.json()

  // 2. ì „í™” ì‹œìž‘
  await fetch(`/api/calls/${call.id}/start`, { method: 'POST' })

  // 3. í†µí™” ì¤‘ í™”ë©´ìœ¼ë¡œ ì´ë™
  router.push(`/calling/${call.id}`)
}
```

---

## Endpoint 2: GET /api/calls

**Owner**: BE1 (route handler) | FE2 (caller)
**Purpose**: Get list of all calls (newest first)

### Response 200 OK
```json
{
  "calls": [
    {
      "id": "clxxxxxxxxxxxxxxxxx",
      "userId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "requestText": "ë‚´ì¼ ì˜¤í›„ 3ì‹œì— OOë¯¸ìš©ì‹¤ ì»¤íŠ¸ ì˜ˆì•½í•´ì¤˜",
      "requestType": "RESERVATION",
      "targetName": "OOë¯¸ìš©ì‹¤",
      "targetPhone": "010-1234-5678",
      "parsedDate": "2026-02-07",
      "parsedTime": "15:00",
      "parsedService": "ì»¤íŠ¸",
      "status": "COMPLETED",
      "result": "SUCCESS",
      "summary": "OOë¯¸ìš©ì‹¤ì— 2026-02-07 15:00 ì»¤íŠ¸ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
      "conversationId": "conv_abc123",
      "createdAt": "2026-02-06T10:30:00.000Z",
      "completedAt": "2026-02-06T10:32:00.000Z"
    }
  ]
}
```

### FE2 Usage Example
```typescript
// app/history/page.tsx (Server Component)
// NOTE: ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” cookies ì „ë‹¬ í•„ìš”
import { cookies } from 'next/headers'

const res = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/calls`, {
  cache: 'no-store',
  headers: { Cookie: (await cookies()).toString() }
})
const { calls }: { calls: Call[] } = await res.json()
```

---

## Endpoint 3: GET /api/calls/[id]

**Owner**: BE1 (route handler) | FE1, FE2 (callers)
**Purpose**: Get single call details + status

### Response 200 OK
```json
{
  "id": "clxxxxxxxxxxxxxxxxx",
  "userId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "requestText": "ë‚´ì¼ ì˜¤í›„ 3ì‹œì— OOë¯¸ìš©ì‹¤ ì»¤íŠ¸ ì˜ˆì•½í•´ì¤˜",
  "requestType": "RESERVATION",
  "targetName": "OOë¯¸ìš©ì‹¤",
  "targetPhone": "010-1234-5678",
  "parsedDate": "2026-02-07",
  "parsedTime": "15:00",
  "parsedService": "ì»¤íŠ¸",
  "status": "COMPLETED",
  "result": "SUCCESS",
  "summary": "OOë¯¸ìš©ì‹¤ì— 2026-02-07 15:00 ì»¤íŠ¸ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  "conversationId": "conv_abc123",
  "createdAt": "2026-02-06T10:30:00.000Z",
  "completedAt": "2026-02-06T10:32:00.000Z"
}
```

### Response 401 Unauthorized
```json
{
  "error": "Unauthorized"
}
```

### Response 404 Not Found
```json
{
  "error": "Call not found"
}
```

### FE2 Polling Usage Example
```typescript
// hooks/useCallPolling.ts
useEffect(() => {
  const interval = setInterval(async () => {
    const res = await fetch(`/api/calls/${callId}`)
    const data: Call = await res.json()
    setCall(data)
    if (data.status === 'COMPLETED' || data.status === 'FAILED') {
      clearInterval(interval)
    }
  }, 3000) // Poll every 3 seconds
  return () => clearInterval(interval)
}, [callId])
```

---

## Endpoint 4: POST /api/calls/[id]/start

**Owner**: BE2 (route handler) | FE1 (caller via ConfirmCard)
**Purpose**: Start the actual phone call via ElevenLabs

### Request
No body required. The call ID in the URL is sufficient.

### Response 200 OK
```json
{
  "success": true,
  "conversationId": "conv_abc123"
}
```

### Response 404 Not Found
```json
{
  "error": "Call not found"
}
```

### Response 500 Internal Server Error
```json
{
  "error": "Failed to start call"
}
```

### FE1 Usage Example (ConfirmCard)
```typescript
// components/call/ConfirmCard.tsx
const handleStartCall = async () => {
  await fetch(`/api/calls/${call.id}/start`, { method: 'POST' })
  router.push(`/calling/${call.id}`)
}
```

---

## Status Flow Diagram

```
PENDING â”€â”€â”€â”€â”€â”€> CALLING â”€â”€â”€â”€â”€â”€> IN_PROGRESS â”€â”€â”€â”€â”€â”€> COMPLETED
   â”‚               â”‚                â”‚                   â”‚
   â”‚               â”‚                â”‚                   â”œâ”€â”€ result: SUCCESS
   â”‚               â”‚                â”‚                   â”œâ”€â”€ result: NO_ANSWER
   â”‚               â”‚                â”‚                   â”œâ”€â”€ result: REJECTED
   â”‚               â”‚                â”‚                   â””â”€â”€ result: ERROR
   â”‚               â”‚                â”‚
   â”‚               â””â”€â”€â”€â”€ FAILED â”€â”€â”€â”€â”˜
   â”‚                      â”‚
   â”‚                      â””â”€â”€ result: ERROR
   â””â”€â”€ (cancelled by user - not implemented in hackathon)
```

### Who Changes Status
| Transition | Owner | Trigger |
|------------|-------|---------|
| PENDING â†’ CALLING | BE2 | `POST /api/calls/[id]/start` called |
| CALLING â†’ IN_PROGRESS | BE2 | ElevenLabs confirms call connected |
| IN_PROGRESS â†’ COMPLETED | BE2 | Polling detects conversation ended |
| CALLING â†’ FAILED | BE2 | ElevenLabs API error |
| IN_PROGRESS â†’ COMPLETED | BE2 | Conversation ends (success or not) |

---

## Mock Mode Behavior

When `ELEVENLABS_MOCK=true`:

1. `POST /api/calls/[id]/start` â†’ sets status to CALLING immediately
2. After 5 seconds â†’ automatically sets status to COMPLETED with result: SUCCESS
3. Summary auto-generated from parsed fields
4. No real API calls made

**This is the default mode. Real ElevenLabs calls only when ELEVENLABS_MOCK=false.**

---

## Field Mapping Reference

| Frontend (camelCase) | DB (camelCase) | API JSON (camelCase) |
|---------------------|----------------|---------------------|
| call.id | Call.id | id |
| call.userId | Call.userId | userId |
| call.requestText | Call.requestText | requestText |
| call.requestType | Call.requestType | requestType |
| call.targetName | Call.targetName | targetName |
| call.targetPhone | Call.targetPhone | targetPhone |
| call.parsedDate | Call.parsedDate | parsedDate |
| call.parsedTime | Call.parsedTime | parsedTime |
| call.parsedService | Call.parsedService | parsedService |
| call.status | Call.status | status |
| call.result | Call.result | result |
| call.summary | Call.summary | summary |
| call.conversationId | Call.conversationId | conversationId |
| call.createdAt | Call.createdAt | createdAt |
| call.completedAt | Call.completedAt | completedAt |

> Note: This project uses camelCase consistently across all layers (no snake_case conversion needed).
